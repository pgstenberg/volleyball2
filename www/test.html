<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hello World</title>
</head>

<style>
    * {padding: 0; margin: 0}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.8.7/pixi.min.js" 
    integrity="sha256-88U/F4bfipOcvifK86snaq0VIYOpwFEc3fIEcpy2PH4=" 
    crossorigin="anonymous"></script>

    <script src="assets/js/input.js"></script>
<script src="assets/js/game.js"></script>

<body>
  <script type="text/javascript">
    let type = "WebGL"
    if(!PIXI.utils.isWebGLSupported()){
      type = "canvas"
    }

    //Create a Pixi Application
    let app = new PIXI.Application({
        antialias: true,    // default: false
        transparent: false, // default: false
        resolution: 1       // default: 1
        }
    );

    app.renderer.autoResize = true;

    app.renderer.view.style.position = "absolute";
    app.renderer.view.style.display = "block";
    app.renderer.autoResize = true;
    app.renderer.resize(window.innerWidth, window.innerHeight);

    //Add the canvas that Pixi automatically created for you to the HTML document
    document.body.appendChild(app.view);

    // Create the main stage for your display objects
    var stage = new PIXI.Container();

    function timestamp() {
        return window.performance && window.performance.now ? window.performance.now() : new Date().getTime();
    };


    var now, 
        dt = 0, 
        last = timestamp(),
        tick = 0;
        step = 1/60;


    function update(delta){
        /*
        if(input[INPUT.RIGHT]){
            graphics.x = graphics.x  + (4 * 60 * delta);
        }else if(input[INPUT.LEFT]){
            graphics.x = graphics.x  - (4 * 60 * delta);
        }*/

        let components = em.getComponents("input", "transform", "graphics");

        Object.keys(components)
            .forEach(function(eid){
                components[eid].input[tick] = input;
                components[eid].transform.x = components[eid].transform.x + 4;

                components[eid].graphics.x = components[eid].transform.x;
            });


        tick++;
    }

    var em = new EntityManager({
        'transform': function(){
            return {
                x: 0,
                y: 0
            };
        },
        'input': function(){
            return {
                0: [false, false, false]
            };
        },
        'graphics': function(){
            return new PIXI.Graphics();
        }
    });

    let id = em.createEntity();
    em.createComponent(id, "input");
    em.createComponent(id, "transform");
    let g = em.createComponent(id, "graphics");

    g.lineStyle(3, 0xffffff);
    g.arc(0, 200, 50, Math.PI, Math.PI * 2);
    // Add the graphics to the stage
    stage.addChild(g);


    // Start animating
    animate();
    function animate() {
        //Render the stage
        app.renderer.render(stage);
        requestAnimationFrame(animate);
    }

    //Start the game loop 
    app.ticker.add(delta => gameLoop(delta));

    function gameLoop(delta){
        const ms = delta / 50;

        now = timestamp();
        dt = dt + Math.min(1, (now - last) / 1000);
        while(dt > step) {
            dt = dt - step;
            update(step);
        }
        last = now;
    }



  </script>
</body>
</html>
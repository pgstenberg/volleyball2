<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hello World</title>
</head>

<style>
    * {padding: 0; margin: 0}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.8.7/pixi.min.js" 
    integrity="sha256-88U/F4bfipOcvifK86snaq0VIYOpwFEc3fIEcpy2PH4=" 
    crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/pixi-filters@2.6.1/dist/pixi-filters.js"></script>

<script src="assets/js/const.js"></script>
<script src="assets/js/input.js"></script>
<script src="assets/js/core.js"></script>
<script src="assets/js/components.js"></script>
<script src="assets/js/systems/transform.js"></script>
<script src="assets/js/systems/gravity.js"></script>
<script src="assets/js/systems/render.js"></script>
<script src="assets/js/systems/input.js"></script>

<body>
  <script type="text/javascript">
    let type = "WebGL"
    if(!PIXI.utils.isWebGLSupported()){
      type = "canvas"
    }

    //Create a Pixi Application
    let app = new PIXI.Application({
        antialias: true,    // default: false
        transparent: false, // default: false
        resolution: 1       // default: 1
        }
    );

    app.renderer.autoResize = true;

    app.renderer.view.style.position = "absolute";
    app.renderer.view.style.display = "block";
    app.renderer.autoResize = true;
    app.renderer.resize(window.innerWidth, window.innerHeight);

    //Add the canvas that Pixi automatically created for you to the HTML document
    document.body.appendChild(app.view);

    // Create the main stage for your display objects
    var stage = new PIXI.Container();

    function timestamp() {
        return window.performance && window.performance.now ? window.performance.now() : new Date().getTime();
    };


    var now, 
        dt = 0, 
        last = timestamp(),
        tick = 0;
        step = 1/60;


    function update(systems, entitymanager, delta, tick){

        Object.keys(systems)
            .sort((s1,s2) => s1 - s2)
            .forEach(idx => systems[idx].update(entitymanager, delta, tick));

    }

    const em = new EntityManager(components);

    const systems = {
        10: new InputSystem(),
        15: new GravitySystem(),
        20: new TransformSystem(),
        100: new RenderSystem(),
    }

    let id = em.createEntity();
    em.createComponent(id, CONSTANTS.COMPONENT.INPUT);
    em.createComponent(id, CONSTANTS.COMPONENT.TRANSFORM);
    em.createComponent(id, CONSTANTS.COMPONENT.VELOCITY);
    em.createComponent(id, CONSTANTS.COMPONENT.JUMPING);
    let g = em.createComponent(id, CONSTANTS.COMPONENT.GRAPHICS);

    g.lineStyle(3, 0xffffff);
    g.arc(0, 200, 50, Math.PI, 0);
    g.lineTo(-50, 200);
   
    // Add the graphics to the stage
    stage.addChild(g);

    
    // Start animating
    animate();
    function animate() {
        //Render the stage
        app.renderer.render(stage);
        requestAnimationFrame(animate);
    }

    //Start the game loop 
    app.ticker.add(delta => gameLoop(delta));

    function gameLoop(delta){
        const ms = delta / 50;

        now = timestamp();
        dt = dt + Math.min(1, (now - last) / 1000);
        while(dt > step) {
            dt = dt - step;
            update(systems, em, step, tick);
            tick = tick + 1;
        }
        last = now;
    }



  </script>
</body>
</html>